#!/bin/bash

# Check if we have at least one argument (input file)
if [ $# -eq 0 ]; then
    echo "Error: No input file provided"
    echo "Usage: micum <input_file> [options]"
    exit 1
fi

# Get absolute path of the input file
INPUT_FILE=$(realpath "$1")
INPUT_DIR=$(dirname "$INPUT_FILE")
FILENAME=$(basename "$INPUT_FILE")

# Check if Docker is installed
if ! command -v docker &>/dev/null; then
    echo "Docker is not installed or not available in the PATH."
    exit 1
fi

# Check if input file exists
if [ ! -f "$INPUT_FILE" ]; then
    echo "Error: Input file '$INPUT_FILE' not found"
    exit 1
fi

# Determine if sudo is needed for Docker
SUDO_CMD=""
if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    if ! groups $(whoami) | grep -q "\bdocker\b"; then
        SUDO_CMD="sudo"
    fi
fi

# Remove first argument (input file) from args list
shift

# Check if Docker image exists
IMAGE=$($SUDO_CMD docker images --format "{{.Repository}}" | grep -E "^shigebio/micum$|^micum$" | head -n 1)
if [ -z "$IMAGE" ]; then
    IMAGE="micum"
    echo "Using image: $IMAGE"
fi

# Run Docker container with the current directory mounted
echo "Running MICUM with input file: $FILENAME"
$SUDO_CMD docker run --rm -it \
    -v "$INPUT_DIR:/workdir" \
    -w /workdir \
    "$IMAGE" \
    micum "/workdir/$FILENAME" "$@"