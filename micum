#!/bin/bash

# Check if we have arguments
if [ $# -eq 0 ]; then
    echo "Usage: $0 <input_file> [options]"
    exit 1
fi

# Get absolute path of the input file
INPUT_FILE=$(cd "$(dirname "$1")" && pwd)/$(basename "$1")
INPUT_DIR=$(dirname "$INPUT_FILE")
FILENAME=$(basename "$INPUT_FILE")

# Check if input file exists
if [ ! -f "$INPUT_FILE" ]; then
    echo "Error: Input file '$INPUT_FILE' not found"
    exit 1
fi

# Check if Docker is installed
if ! command -v docker &>/dev/null; then
    echo "Error: Docker is not installed or not available in the PATH."
    exit 1
fi

# Remove first argument (input file) from args list
shift

# Check for Docker image
IMAGE=$(docker images --format "{{.Repository}}" | grep -E "^shigebio/micum$|^micum$" | head -n 1)
if [ -z "$IMAGE" ]; then
    IMAGE="micum"
    echo "Using default image name: $IMAGE"
    # Check if image exists
    if ! docker images | grep -q "$IMAGE"; then
        echo "Error: Docker image '$IMAGE' not found."
        echo "Please build the image first with: docker build -t micum ."
        exit 1
    fi
fi

echo "-------------------------------------------"
echo "Running MICUM with:"
echo "Input file: $FILENAME"
echo "Input directory: $INPUT_DIR"
echo "Docker image: $IMAGE"
echo "Additional options: $@"
echo "-------------------------------------------"

# Run Docker container directly with the appropriate command
docker run --rm -it \
    -v "$INPUT_DIR:/workdir" \
    -w /workdir \
    "$IMAGE" \
    python3 /app/MICUM.py "/workdir/$FILENAME" "$@"

exit_code=$?
if [ $exit_code -ne 0 ]; then
    echo "Error: MICUM execution failed with exit code $exit_code"
    exit $exit_code
fi