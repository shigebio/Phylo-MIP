#!/bin/bash

# Check if we have arguments
if [ $# -lt 6 ]; then
    echo "Error: Insufficient arguments provided"
    echo "Usage: $0 -q <qiime_file> -m <Phylo-MIP_file> -f <format> [-o <output_file>] [-d]"
    exit 1
fi

# Parse arguments to find file paths
QIIME_FILE=""
PM_FILE=""
FORMAT=""
OUTPUT_FILE=""
DEBUG=""
OTHER_ARGS=""

# Simple argument parser
index=1
while [ $index -le $# ]; do
    current_arg=${!index}

    if [ "$current_arg" = "-q" ]; then
        next_index=$((index + 1))
        QIIME_FILE=${!next_index}
        index=$((index + 2))
    elif [ "$current_arg" = "-m" ]; then
        next_index=$((index + 1))
        PM_FILE=${!next_index}
        index=$((index + 2))
    elif [ "$current_arg" = "-f" ]; then
        next_index=$((index + 1))
        FORMAT=${!next_index}
        index=$((index + 2))
    elif [ "$current_arg" = "-o" ]; then
        next_index=$((index + 1))
        OUTPUT_FILE=${!next_index}
        index=$((index + 2))
    elif [ "$current_arg" = "-d" ]; then
        DEBUG="-d"
        index=$((index + 1))
    else
        OTHER_ARGS="$OTHER_ARGS $current_arg"
        index=$((index + 1))
    fi
done

# Check if required files were specified
if [ -z "$QIIME_FILE" ] || [ -z "$PM_FILE" ] || [ -z "$FORMAT" ]; then
    echo "Error: QIIME file (-q), Phylo-MIP file (-m), and format (-f) must be specified"
    exit 1
fi

# Get absolute paths of input files (cross-platform compatible way)
case "$(uname -s)" in
    Darwin)
        # macOS approach
        QIIME_FILE=$(cd "$(dirname "$QIIME_FILE")" && pwd)/$(basename "$QIIME_FILE")
        PM_FILE=$(cd "$(dirname "$PM_FILE")" && pwd)/$(basename "$PM_FILE")
        ;;
    *)
        # Linux/Windows WSL approach
        if command -v realpath &> /dev/null; then
            QIIME_FILE=$(realpath "$QIIME_FILE")
            PM_FILE=$(realpath "$PM_FILE")
        else
            QIIME_FILE=$(cd "$(dirname "$QIIME_FILE")" && pwd)/$(basename "$QIIME_FILE")
            PM_FILE=$(cd "$(dirname "$PM_FILE")" && pwd)/$(basename "$PM_FILE")
        fi
        ;;
esac

# Check if files exist
if [ ! -f "$QIIME_FILE" ]; then
    echo "Error: QIIME file not found: $QIIME_FILE"
    exit 1
fi

if [ ! -f "$PM_FILE" ]; then
    echo "Error: Phylo-MIP file not found: $PM_FILE"
    exit 1
fi

# Get current directory and file names
CURRENT_DIR=$(pwd)
QIIME_BASENAME=$(basename "$QIIME_FILE")
PM_BASENAME=$(basename "$PM_FILE")

# Create a temporary directory
TEMP_DIR=$(mktemp -d)
echo "Creating temporary directory: $TEMP_DIR"

# Copy files to temp directory
cp "$QIIME_FILE" "$TEMP_DIR/qiime_file"
cp "$PM_FILE" "$TEMP_DIR/pm_file"

# Platform detection for Docker
case "$(uname -s)" in
    Darwin)
        # macOS needs platform specification
        PLATFORM_FLAG="--platform linux/amd64"
        ;;
    *)
        # Linux/Windows WSL doesn't need platform specification
        PLATFORM_FLAG=""
        ;;
esac

# User ID handling (WSL compatibility)
if command -v id &> /dev/null; then
    USER_FLAG="--user $(id -u):$(id -g)"
else
    USER_FLAG=""
fi

# Determine output filename if provided
OUTPUT_ARGS=""
if [ -n "$OUTPUT_FILE" ]; then
    OUTPUT_BASENAME=$(basename "$OUTPUT_FILE")
    OUTPUT_ARGS="-o $OUTPUT_BASENAME"
fi

echo "Running Docker with files from temporary directory"

# Run Docker container with the appropriate command
docker run --rm -it ${PLATFORM_FLAG} \
    -v "$TEMP_DIR:/workdir" \
    -w /workdir \
    ${USER_FLAG} \
    phylo-mip \
    python3 /app/merge_data.py -q "/workdir/qiime_file" -m "/workdir/pm_file" -f "$FORMAT" $OUTPUT_ARGS $DEBUG $OTHER_ARGS

# Check the Docker exit status
DOCKER_STATUS=$?
if [ $DOCKER_STATUS -ne 0 ]; then
    echo "Error: Docker command failed with status $DOCKER_STATUS"
fi

# Determine the output file name pattern
if [ -n "$OUTPUT_FILE" ]; then
    OUTPUT_PATTERN="${OUTPUT_BASENAME}*"
else
    OUTPUT_PATTERN="*_merged.*"
fi

# Copy all possible output files from temp dir to current directory
echo "Copying output files back to current directory"
find "$TEMP_DIR" -maxdepth 1 \( -name "*.csv" -o -name "*.tsv" \) -type f | while read file; do
    cp "$file" "$CURRENT_DIR/"
    echo "Copied: $(basename "$file")"
done

# Count how many files were copied
OUTPUT_COUNT=$(find "$TEMP_DIR" -name "$OUTPUT_PATTERN" -o -name ".csv" -o -name ".tsv" | wc -l)

# Clean up temporary directory
echo "Cleaning up temporary directory"
if ! rm -rf "$TEMP_DIR" 2>/dev/null; then
    if command -v sudo &> /dev/null; then
        echo "Using sudo to remove temporary directory"
        sudo rm -rf "$TEMP_DIR"
    fi
fi

# Final confirmation
if [ "$OUTPUT_COUNT" -gt 0 ]; then
    echo "Process complete. Output files saved to current directory."
else
    echo "WARNING: No output files were found! Check for errors in the processing."
fi
