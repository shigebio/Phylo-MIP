#!/bin/bash

# Check if we have arguments
if [ $# -eq 0 ]; then
    echo "Error: No arguments provided"
    echo "Usage: $0 [options]"
    echo "Options should include -q and -m for input files"
    exit 1
fi

# Current directory for mounting
INPUT_DIR=$(pwd)

# Check if Docker is installed
if ! command -v docker &>/dev/null; then
    echo "Error: Docker is not installed or not available in the PATH."
    exit 1
fi

# Check for Docker image
IMAGE=$(docker images --format "{{.Repository}}" | grep -E "^shigebio/micum$|^micum$" | head -n 1)
if [ -z "$IMAGE" ]; then
    IMAGE="micum"
    echo "Using default image name: $IMAGE"
    # Check if image exists
    if ! docker images | grep -q "$IMAGE"; then
        echo "Error: Docker image '$IMAGE' not found."
        echo "Please build the image first with: docker build -t micum ."
        exit 1
    fi
fi

echo "-------------------------------------------"
echo "Running merge_data with:"
echo "Current directory: $INPUT_DIR"
echo "Docker image: $IMAGE"
echo "Arguments: $@"
echo "-------------------------------------------"

# Run Docker container directly with the appropriate command
docker run --rm -it \
    -v "$INPUT_DIR:/workdir" \
    -w /workdir \
    "$IMAGE" \
    python3 /app/merge_data.py "$@"

exit_code=$?
if [ $exit_code -ne 0 ]; then
    echo "Error: merge_data execution failed with exit code $exit_code"
    exit $exit_code
fi